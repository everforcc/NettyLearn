<span  style="font-family: Simsun,serif; font-size: 17px; ">

[TOC]

### 黏包半包

- 现象演示
- TCP 有
- UDP 没有

### 1 黏包

- 多个消息合到一起
- 或者被分散开

#### 1.1 TCP层面-滑动窗口

- 窗口实际就起到一个缓冲区的作用，同时也能起到流量控制的作用
    - 图中深色的部分即要发送的数据，高亮的部分即窗口
    - 窗口内的数据才允许被发送，当应答未到达前，窗口必须停止滑动
    - 如果 1001~2000 这个段的数据 ack 回来了，窗口就可以向前滑动
    - 接收方也会维护一个窗口，只有落在窗口内的数据才能允许接收
- 底层
    - 发送缓冲区
    - 接收缓冲区
- 网络繁忙或者别的时候，也会导致黏包半包
    - 黏包，缓冲区比较空闲
    - 半包，发了上半后没空闲缓冲区了，下半没发过去

#### 1.2 TCP层面-Nagle算法

- 会造成黏包
- 暂够了数据再发

#### 1.3 应用层-ByteBuf

- ByteBuf 默认为1024，大于实际发送数据量

### 2. 半包

#### 2.1 TCP-滑动窗口

- 假设接收方窗口只剩下了128 bytes，发送方要发送256，只能先发前128，等ack后才能发送剩余部分，造成半包

#### 2.2 链路层-MSS限制

- 更底层，例如网卡也有限制，
    - 1500 - 40(报文头)
- 超过MSS限制后，会将数据切分发送，就会造成半包

#### 2.3 应用层

- 接收方 ByteBuf 小于实际发送数据量

### 3. 本质

- TCP是流试协议，消息无边界

</span>